#!/bin/sh

printf "Content-type: application/json\r\n\r\n"

HOSTNAME=$(hostname)
FW_VERSION=$(cat /mnt/mmc/sonoff-hack/version)
HOME_VERSION=$(cat /mnt/mtd/ipc/cfg/version)
MODEL=$(cat /mnt/mtd/ipc/cfg/config_cst.cfg | grep model | cut -d'=' -f2 | cut -d'"' -f2)
#SERIAL_NUMBER=$(dd status=none bs=1 count=20 skip=661 if=/tmp/mmap.info)
SERIAL_NUMBER="SN"
LOCAL_TIME=$(date)
UPTIME=$(cat /proc/uptime | cut -d ' ' -f1)
LOAD_AVG=$(cat /proc/loadavg | cut -d ' ' -f1-3)
TOTAL_MEMORY=$(free -k | awk 'NR==2{print $2}')
FREE_MEMORY=$(free -k | awk 'NR==2{print $4+$6+$7}')
FREE_SD=$(df -h /mnt/mmc | grep mmc | awk '{print $5}' | tr -d '%')
if [ -z "$FREE_SD" ]; then
    FREE_SD="N/A"
else
    FREE_SD=$((100-$FREE_SD))%
fi

LOCAL_IP_E=$(ifconfig eth0 | awk '/inet addr/{print substr($2,6)}')
NETMASK_E=$(ifconfig eth0 | awk '/inet addr/{print substr($4,6)}')
if [ -z $LOCAL_IP_E ]; then
    LOCAL_IP_E="N/A"
    NETMASK_E="N/A"
fi
LOCAL_IP_W=$(ifconfig ra0 | awk '/inet addr/{print substr($2,6)}')
NETMASK_W=$(ifconfig ra0 | awk '/inet addr/{print substr($4,6)}')
if [ -z $LOCAL_IP_W ]; then
    LOCAL_IP_W="N/A"
    NETMASK_W="N/A"
fi
GATEWAY=$(route -n | awk 'NR==3{print $2}')
if [ -z $GATEWAY ]; then
    GATEWAY="N/A"
fi
MAC_ADDR_E=$(ifconfig eth0 | awk '/HWaddr/{print substr($5,1)}')
MAC_ADDR_W=$(ifconfig ra0 | awk '/HWaddr/{print substr($5,1)}')
WLAN_ESSID=$(iwconfig ra0 | grep ESSID | cut -d\" -f2)
if [ -z $WLAN_ESSID ]; then
    WLAN_ESSID="N/A"
fi

# Yeah, it's pretty ugly.. but hey, it works.

printf "{\n"
printf "\"%s\":\"%s\",\n" "hostname"        "$HOSTNAME"
printf "\"%s\":\"%s\",\n" "fw_version"      "$FW_VERSION"
printf "\"%s\":\"%s\",\n" "home_version"    "$HOME_VERSION"
printf "\"%s\":\"%s\",\n" "model"           "$MODEL"
printf "\"%s\":\"%s\",\n" "serial_number"   "$SERIAL_NUMBER"
printf "\"%s\":\"%s\",\n" "local_time"      "$LOCAL_TIME"
printf "\"%s\":\"%s\",\n" "uptime"          "$UPTIME"
printf "\"%s\":\"%s\",\n" "load_avg"        "$LOAD_AVG"
printf "\"%s\":\"%s\",\n" "total_memory"    "$TOTAL_MEMORY"
printf "\"%s\":\"%s\",\n" "free_memory"     "$FREE_MEMORY"
printf "\"%s\":\"%s\",\n" "free_sd"         "$FREE_SD"

printf "\"%s\":\"%s\",\n" "local_ip_e"      "$LOCAL_IP_E"
printf "\"%s\":\"%s\",\n" "netmask_e"       "$NETMASK_E"
printf "\"%s\":\"%s\",\n" "local_ip_w"      "$LOCAL_IP_W"
printf "\"%s\":\"%s\",\n" "netmask_w"       "$NETMASK_W"
printf "\"%s\":\"%s\",\n" "gateway"         "$GATEWAY"
printf "\"%s\":\"%s\",\n" "mac_addr_e"      "$MAC_ADDR_E"
printf "\"%s\":\"%s\",\n" "mac_addr_w"      "$MAC_ADDR_W"
printf "\"%s\":\"%s\" \n" "wlan_essid"      "$WLAN_ESSID"

printf "}"
