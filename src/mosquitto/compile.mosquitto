#!/bin/bash

set -e

source config.mosquitto

if [ "$USE_MOSQUITTO" != "1" ]; then
    exit
fi

SCRIPT_DIR=$(cd `dirname $0` && pwd)
cd $SCRIPT_DIR

cd "${BUILD_FOLDER}"

export CXX=g++

make clean
make -j$(nproc) binary \
    CROSS_COMPILE=arm-sonoff-linux-uclibcgnueabi- \
    CC=gcc \
    ARCH=arm \
    CFLAGS="-Os -I${SCRIPT_DIR}/../cJSON/_install/include -DIPV6_V6ONLY=26" \
    LDFLAGS="-L${SCRIPT_DIR}/../cJSON/_install/lib" \
    WITH_SRV=no \
    WITH_UUID=no \
    WITH_WEBSOCKETS=no \
    WITH_TLS=no \
    WITH_MEMORY_TRACKING=no \
    WITH_DOCS=no
   

mkdir -p ../_install/bin
mkdir -p ../_install/lib
mkdir -p ../_install/include

cp ./client/mosquitto_pub ../_install/bin
cp ./client/mosquitto_sub ../_install/bin

cp ./lib/libmosquitto.so.1 ../_install/lib
cp ./include/mosquitto.h ../_install/include

arm-sonoff-linux-uclibcgnueabi-strip ../_install/bin/*
arm-sonoff-linux-uclibcgnueabi-strip ../_install/lib/*
